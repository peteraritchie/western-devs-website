<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Doing Snapshots on Azure Virtual Machines | Western Devs</title>
  <meta name="description" content="I&apos;ve always been frustrated that I can&apos;t do snapshots when I&apos;m using VM&apos;s in Azure. Especially when I&apos;m developing some deployment automation, I like to be able to try something out - and when it inev">
<meta property="og:type" content="article">
<meta property="og:title" content="Doing Snapshots on Azure Virtual Machines">
<meta property="og:url" content="http://www.westerndevs.com/azure-snapshots/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="I&apos;ve always been frustrated that I can&apos;t do snapshots when I&apos;m using VM&apos;s in Azure. Especially when I&apos;m developing some deployment automation, I like to be able to try something out - and when it inev">
<meta property="og:image" content="http://i.imgur.com/waHMXxG.png">
<meta property="og:image" content="http://i.imgur.com/601dKeE.png">
<meta property="og:image" content="http://i.imgur.com/EjdOOxL.png">
<meta property="og:image" content="http://i.imgur.com/05cF86c.png">
<meta property="og:image" content="http://i.imgur.com/QKLize8.png">
<meta property="og:image" content="http://i.imgur.com/psVa4XE.png">
<meta property="og:image" content="http://i.imgur.com/yh9cgcp.png">
<meta property="og:updated_time" content="2017-05-18T21:09:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Doing Snapshots on Azure Virtual Machines">
<meta name="twitter:description" content="I&apos;ve always been frustrated that I can&apos;t do snapshots when I&apos;m using VM&apos;s in Azure. Especially when I&apos;m developing some deployment automation, I like to be able to try something out - and when it inev">
<meta name="twitter:image" content="http://i.imgur.com/waHMXxG.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="alternate" href="/feed" title="Western Devs" type="application/atom+xml">
  
  <link rel="stylesheet" href="/css/style.css">
      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  </head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">NOV</div>
    <div class="ListLrgDateDay">4</div>
    <div class="ListLrgDateYear">2015</div>
  </div>
  <h2>Doing Snapshots on Azure Virtual Machines</h2>
</div>

		    

			<div id="mainPostContent">
	        <p>I've always been frustrated that I can't do snapshots when I'm using VM's in Azure. Especially when I'm developing some deployment automation, I like to be able to try something out - and when it inevitably screws up - reset the VM to a snapshot and try again.</p>
<a id="more"></a>
<p>We still can't do actual snapshots, but I've written some powershell that achieves the same goal.  It will grab a copy of the VHD file (this acts as the snapshot), then when we want to restore to snapshot we'll just swap out the VHD's.  The trick here is that Azure won't let you swap out the VHD for an existing VM, so we need to actually destroy the VM, swap out the VHD's, then recreate the VM using the existing VHD.</p>
<blockquote>
<p>Note: This is all done using ARM (Azure Resource Manager) style VM's.</p>
</blockquote>
<p>If you want to try it out, here's a step-by-step to try it out:</p>
<p>First create a VM in Azure, and be sure to select Resource Manager as the deployment model:</p>
<p><img src="http://i.imgur.com/waHMXxG.png" alt="Create ARM VM"></p>
<p><img src="http://i.imgur.com/601dKeE.png" alt="VM Basics"></p>
<p><img src="http://i.imgur.com/EjdOOxL.png" alt="Select VM Size"></p>
<p><img src="http://i.imgur.com/05cF86c.png" alt="VM Settings"></p>
<p>After it's done processing we'll have a new Resource Group with 6 resources included:</p>
<p><img src="http://i.imgur.com/QKLize8.png" alt="Resource Group"></p>
<p>One thing I like to do - that the wizard doesn't let you specify - is to assign a DNS name to the public IP that I'll use to connect to my VM.  You can set this in the configuration page for the Public IP resource.</p>
<p><img src="http://i.imgur.com/psVa4XE.png" alt="Set DNS"></p>
<p>Lastly, I need to copy the Storage Account Access Key for use in the powershell.</p>
<p><img src="http://i.imgur.com/yh9cgcp.png" alt="Retrieve Storage Key"></p>
<p>Now all we need to do is take the powershell below, and modify the values of the variables at the start to match the names you used when you created the VM/Resource Group.</p>
<p>The first time you run the script it will create the initial snapshot.  All subsequent times you run the script it will reset it to that snapshot.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Set variable values</span></div><div class="line"><span class="variable">$resourceGroupName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$location</span> = <span class="string">"West US"</span></div><div class="line"><span class="variable">$vmName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$vmSize</span> = <span class="string">"Standard_D1"</span></div><div class="line"><span class="variable">$vnetName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$nicName</span> = <span class="string">"dylandemo665"</span></div><div class="line"><span class="variable">$dnsName</span> = <span class="string">"dylandemo"</span></div><div class="line"><span class="variable">$diskName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$storageAccount</span> = <span class="string">"dylandemo"</span></div><div class="line"><span class="variable">$storageAccountKey</span> = <span class="string">"Enter Storage Key Here"</span></div><div class="line"><span class="variable">$subscriptionName</span> = <span class="string">"MSDN MPN"</span></div><div class="line"><span class="variable">$publicIpName</span> = <span class="string">"DylanDemo"</span></div><div class="line"></div><div class="line"><span class="variable">$diskBlob</span> = <span class="string">"<span class="variable">$diskName</span>.vhd"</span></div><div class="line"><span class="variable">$backupDiskBlob</span> = <span class="string">"<span class="variable">$diskName</span>-backup.vhd"</span></div><div class="line"><span class="variable">$vhdUri</span> = <span class="string">"https://<span class="variable">$storageAccount</span>.blob.core.windows.net/vhds/<span class="variable">$diskBlob</span>"</span></div><div class="line"><span class="variable">$subnetIndex</span> = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment"># login to Azure</span></div><div class="line">Add-AzureAccount</div><div class="line">Select-AzureSubscription -SubscriptionName <span class="variable">$subscriptionName</span></div><div class="line">Switch-AzureMode AzureResourceManager</div><div class="line"></div><div class="line"><span class="comment"># create backup disk if it doesn't exist</span></div><div class="line">Stop-AzureVM -ResourceGroupName <span class="variable">$resourceGroupName</span> -Name <span class="variable">$vmName</span> -Force -Verbose</div><div class="line"></div><div class="line"><span class="variable">$ctx</span> = New-AzureStorageContext -StorageAccountName <span class="variable">$storageAccount</span> -StorageAccountKey <span class="variable">$storageAccountKey</span></div><div class="line"><span class="variable">$blobCount</span> = Get-AzureStorageBlob -Container vhds -Context <span class="variable">$ctx</span> | where &#123; <span class="variable">$_</span>.Name <span class="nomarkup">-eq</span> <span class="variable">$backupDiskBlob</span> &#125; | Measure | % &#123; <span class="variable">$_</span>.Count &#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$blobCount</span> <span class="nomarkup">-eq</span> <span class="number">0</span>)</div><div class="line">&#123;</div><div class="line">  <span class="variable">$copy</span> = Start-AzureStorageBlobCopy -SrcBlob <span class="variable">$diskBlob</span> -SrcContainer <span class="string">"vhds"</span> -DestBlob <span class="variable">$backupDiskBlob</span> -DestContainer <span class="string">"vhds"</span> -Context <span class="variable">$ctx</span> -Verbose</div><div class="line">  <span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line">  <span class="variable">$status</span> </div><div class="line"></div><div class="line">  <span class="keyword">While</span>(<span class="variable">$status</span>.Status <span class="nomarkup">-eq</span> <span class="string">"Pending"</span>)&#123;</div><div class="line">    <span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line">    <span class="built_in">Start-Sleep</span> <span class="number">10</span></div><div class="line">    <span class="variable">$status</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># delete VM</span></div><div class="line">Remove-AzureVM -ResourceGroupName <span class="variable">$resourceGroupName</span> -Name <span class="variable">$vmName</span> -Force -Verbose</div><div class="line">Remove-AzureStorageBlob -Blob <span class="variable">$diskBlob</span> -Container <span class="string">"vhds"</span> -Context <span class="variable">$ctx</span> -Verbose</div><div class="line">Remove-AzureNetworkInterface -Name <span class="variable">$nicName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -Force -Verbose</div><div class="line">Remove-AzurePublicIpAddress -Name <span class="variable">$publicIpName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -Force -Verbose</div><div class="line"></div><div class="line"><span class="comment"># copy backup disk</span></div><div class="line"><span class="variable">$copy</span> = Start-AzureStorageBlobCopy -SrcBlob <span class="variable">$backupDiskBlob</span> -SrcContainer <span class="string">"vhds"</span> -DestBlob <span class="variable">$diskBlob</span> -DestContainer <span class="string">"vhds"</span> -Context <span class="variable">$ctx</span> -Verbose</div><div class="line"><span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line"><span class="variable">$status</span> </div><div class="line"></div><div class="line"><span class="keyword">While</span>(<span class="variable">$status</span>.Status <span class="nomarkup">-eq</span> <span class="string">"Pending"</span>)&#123;</div><div class="line">  <span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line">  <span class="built_in">Start-Sleep</span> <span class="number">10</span></div><div class="line">  <span class="variable">$status</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># recreate VM</span></div><div class="line"><span class="variable">$vnet</span> = Get-AzurevirtualNetwork -Name <span class="variable">$vnetName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span></div><div class="line"></div><div class="line"><span class="variable">$pip</span> = New-AzurePublicIpAddress -Name <span class="variable">$publicIpName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -DomainNameLabel <span class="variable">$dnsName</span> -Location <span class="variable">$location</span> -AllocationMethod Dynamic -Verbose</div><div class="line"><span class="variable">$nic</span> = New-AzureNetworkInterface -Name <span class="variable">$nicName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -Location <span class="variable">$location</span> -SubnetId <span class="variable">$vnet</span>.Subnets[<span class="variable">$subnetIndex</span>].Id -PublicIpAddressId <span class="variable">$pip</span>.Id -Verbose</div><div class="line"><span class="variable">$vm</span> = New-AzureVMConfig -VMName <span class="variable">$vmName</span> -VMSize <span class="variable">$vmSize</span></div><div class="line"><span class="variable">$vm</span> = Add-AzureVMNetworkInterface -VM <span class="variable">$vm</span> -Id <span class="variable">$nic</span>.Id</div><div class="line"><span class="variable">$vm</span> = Set-AzureVMOSDisk -VM <span class="variable">$vm</span> -Name <span class="variable">$diskName</span> -VhdUri <span class="variable">$vhdUri</span> -CreateOption attach -Windows</div><div class="line"></div><div class="line">New-AzureVM -ResourceGroupName <span class="variable">$resourceGroupName</span> -Location <span class="variable">$location</span> -VM <span class="variable">$vm</span> -Verbose</div></pre></td></tr></table></figure>
	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/dylan_smith">
				
					<img src='/images/avatars/dylan_300x300.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/dylan_smith">Dylan Smith</a></h2>
			
			<a href="mailto:optikal@shaw.ca"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://www.geekswithblogs.net/optikal" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/dylan_smith" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			
			
 			<a href="/feeds/dylan_smith"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'http://www.westerndevs.com/azure-snapshots/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'dylan_smith');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
