<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Western Devs</title>
  
  <link href="/feeds/dylan_smith" rel="self" type="application/atom+xml"/>
  <link href="http://www.westerndevs.com" rel="alternate" type="application/atom+xml"/>
  
  <updated>2017-05-18T21:09:05.000Z</updated>
  <id>http://www.westerndevs.com/</id>
  
  <author>
    <name>Western Devs</name>
	<uri>http://www.westerndevs.com</uri>
    <email>info@westerndevs.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title type="html">Synchronize GitHub Repository with VSTS</title>
    <link href="http://www.westerndevs.com//Synchronize-GitHub-Repository-With-VSTS/" rel="alternate" type="text/html"/>
    <id>http://www.westerndevs.com//Synchronize-GitHub-Repository-With-VSTS/</id>
    <published>2017-03-08T19:00:00.000Z</published>
    <updated>2017-05-18T21:09:05.000Z</updated>
	<author>
	
	  
	  <name>Dylan Smith</name>
	  <email>optikal@shaw.ca</email>
	
	  <uri>http://www.westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>A fellow Western Dev - Justin Self - was telling me he uses GitHub for source control and VSTS for Work Items, and was wondering if it's possible to link the Work Items to GitHub commits.  If you're using VSTS for source control, you can do this easily by mentioning the Work Item ID in your commit message like so: Fixing Bug #123.  And VSTS will automatically create a link between the Work Item and the Git commit.  If you're using GitHub for source control, I don't believe there's an out of the box way to make this work.</p><p>We came up with an idea, what if we could synchronize the GitHub repository to a VSTS repository.  Then VSTS could see the commits and create the WI links.  So that's what we did, and this blog post explains how you can do the same thing.</p><p>First things first, you need to create a VSTS Build that points to your GitHub repo.  That's easy enough, as support is built right into VSTS builds to do this.</p><ol><li>Go to Builds and Create a New Definition (Note: I'm using the new build editing experience - which you can turn on for your account if you haven't already).</li><li>Choose the Empty Process option</li><li>Configure the Get Sources task to use GitHub as the source, and give the connection a name</li><li>Click Authorize using Oauth - at this step you may be prompted for your GitHub credentials and to Authorize VSTS to talk to GitHub</li><li>Pick the GitHub repo and branch - I just left this as master, but later we will set it up to synch all branches</li><li>Go to the Triggers tab and turn on Continuous Integration, and change the branch to include to * to trigger a build on commits/pushes to any branch</li><li>Under Options turn on Allow Scripts to Access Oauth token - we'll use this later</li><li>Save and Queue a build to check if it works</li></ol><p><img src="http://imgur.com/YzvjdpQ.png" alt="New Build Definition"></p><p><img src="http://imgur.com/bnugm3O.png" alt="Select Build Template"></p><p><img src="http://imgur.com/ms364Zw.png" alt="Configure Source Repo"></p><p><img src="http://imgur.com/LSQDzg2.png" alt="GH Repo Configured"></p><p><img src="http://imgur.com/w8bYFxi.png" alt="Configure CI"></p><p><img src="http://imgur.com/Z6Eei4O.png" alt="Configure OAuth"></p><p><img src="http://imgur.com/PxGFis0.png" alt="Test Build Output"></p><p>Alright, now we have a build that triggers on every GitHub commit/push, and will download the GH repo to the build agent.  The next step is to make it push any and all changes into the VSTS repo.  To do this I shamelessly copied a snippet of bash from StackOverflow.  There is a built-in build task to run a bash script - Shell Script - but that requires you to point it to a script inside your repo, which is more work than I wanted.  I just want to write the few lines of bash directly in the build.</p><p><img src="http://imgur.com/OQCpY7W.png" alt="Default Shell Task"></p><p>Fortunately there is a VSTS extension in the marketplace that lets us do exactly this: https://marketplace.visualstudio.com/items?itemName=tsuyoshiushio.shell-exec</p><p><img src="http://imgur.com/bSzWWig.png" alt="Extension Shell Task"></p><p>Once I installed that extension into my VSTS account, I can now add it as a task to my build and tell it the bash script I want it to run:</p><p><img src="http://imgur.com/C1tVW5x.png" alt="Install Extension"></p><p><img src="http://imgur.com/SmKJlax.png" alt="Confirm Extension"></p><p><img src="http://imgur.com/R8zE0ss.png" alt="Extension Installed"></p><p><img src="http://imgur.com/wJZmhuE.png" alt="Add New Task"></p><p><img src="http://imgur.com/ErwFNbF.png" alt="Configure Shell Task"></p><p>Those 3 lines of bash using the git command-line are all it takes.  The one tricky bit to figure out was how to make sure it synchronized all branches - even newly created branches - in github into VSTS.  The trickery in line 1 and 3 does that.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git branch -r | grep -v '\-&gt;' | while read remote; do git branch --track "$&#123;remote#origin/&#125;" "$remote"; done</div><div class="line">git remote add vsts https://pokerleaguemanager.visualstudio.com/DefaultCollection/_git/GitHubSync</div><div class="line">git branch -r | grep -v '\-&gt;' | while read remote; do git -c http.extraheader="AUTHORIZATION: bearer $SYSTEM_ACCESSTOKEN" push -u vsts "$&#123;remote#origin/&#125;"; done</div></pre></td></tr></table></figure><p>That script is doing a few things:</p><ol><li>Loop through all branches in origin and create local branches to track them. Note: Because GH was setup as the repo for this build, VSTS has already created the git repo, setup origin to point to GH, and downloaded the repo to the build agent.</li><li>Add the VSTS repo as a new remote called vsts</li><li>Loop through all branches and push each one to VSTS</li></ol><p>The stuff with $SYSTEM_ACCESSTOKEN in line 3 is accessing an environment variable that contains an Oauth token that can be used to communicate with VSTS - in a previous step where we set the option in the VSTS build to make Oauth token available to scripts, is what allows this to work.</p><p>There's one thing left to do to make this all work - we need to grant the build service account access to the VSTS repo.  We can do this in the repo security screen like so:</p><p><img src="http://imgur.com/eCYpGEC.png" alt="Configure Security"></p><p>Now you can push some commits to GitHub and/or create a new branch, and the VSTS build should automatically trigger and synch the VSTS repo up almost immediately.  If everything is working you should see build output that looks something like this:</p><p><img src="http://imgur.com/E3GhdJI.png" alt="Successful Build Output"></p>]]></content>
    
    <summary type="html">
    
      Step by step guide to do an automated continuous one-way synchronization from a GitHub repository to a VSTS repository.
    
    </summary>
    
    
      <category term="vsts" scheme="http://www.westerndevs.com/tags/vsts/"/>
    
      <category term="github" scheme="http://www.westerndevs.com/tags/github/"/>
    
      <category term="devops" scheme="http://www.westerndevs.com/tags/devops/"/>
    
  </entry>
  
  <entry>
    <title type="html">What Is DevOps?</title>
    <link href="http://www.westerndevs.com/alm/What-Is-DevOps/" rel="alternate" type="text/html"/>
    <id>http://www.westerndevs.com/alm/What-Is-DevOps/</id>
    <published>2016-11-18T07:14:00.000Z</published>
    <updated>2017-05-18T21:09:05.000Z</updated>
	<author>
	
	  
	  <name>Dylan Smith</name>
	  <email>optikal@shaw.ca</email>
	
	  <uri>http://www.westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>I'm sure there's hundreds of posts out there trying to define DevOps, this is my $0.02 on the topic.</p><p>If you subscribe to the lean software development way of thinking, you think about a pipeline of value that results in working software.  For example this might be: Analysis -&gt; Dev -&gt; Test -&gt; Deploy -&gt; Monitor</p><p>As with any pipeline, there is likely a bottleneck somewhere that restricts the flow of value.  Lean is all about identifying and attacking these bottlenecks.  10 years ago - before Agile - the bottleneck was probably Analysis, or maybe Test.  With Agile development becoming mainstream over the last decade, it has done a pretty good job of attacking those bottlenecks, resulting in analysis and test becoming more just-in-time, spread out over the course of a project, and embedded in the regular dev workflows.  They are no longer the bottleneck.</p><p>A new bottleneck has arisen, that is at the boundary of the dev/test team and the operations team.  These tend to be very separate teams, with a clear handoff between them.  This results in friction, and a bottleneck in the flow of value.</p><p>So back to my definition of DevOps:</p><h3>DevOps is recognizing that a bottleneck exists between Development and Operations, and doing something to address it.</h3><p>This bottleneck manifests itself in a number of ways, here's a few common ones:</p><ol><li>Provisioning / Managing Infrastructure - Creating environments for dev/test/uat/prod, and managing or making changes to those environments.</li><li>Deployment to Production - Still often done by writing word documents with deployment instructions, scheduling a time for Operations team to do the deployment, then delivering the document and deployment packages to Operations.</li><li>Production Support / Monitoring - Is the application available, are there errors, what is the load on the servers.</li></ol><p>These are common causes of friction within development organizations.  I could go into details, but I expect just reading the points above you can identify with at least some of these concerns.</p><p>When I hear people talk about DevOps, I often hear 3 common approaches:</p><ol><li>Closer collaboration between the development and operations team.  Perhaps having an Ops team member actively involved with the dev team throughout the project.</li><li>Increased Dev Team Responsibility - Writing automation scripts to provision / manage environments, deployment automation scripts, etc</li><li>New Role: DevOps Engineer - Introducing a new role specifically to sit between dev and ops to facilitate the automation and collaboration.</li></ol><p>Although #2 is the approach I see most often, I believe all 3 approaches are perfectly valid ways to attack the problem.</p><p>If you want help adopting DevOps practices or technologies, my company Imaginet is always happy to help.  Check out our DevOps offerings here: <a href="http://www.imaginet.com/devops-as-a-service/" target="_blank" rel="external">http://www.imaginet.com/devops-as-a-service/</a></p>]]></content>
    
    <summary type="html">
    
      My personal definition of DevOps, in the context of lean principles.
    
    </summary>
    
      <category term="alm" scheme="http://www.westerndevs.com/categories/alm/"/>
    
    
      <category term="alm" scheme="http://www.westerndevs.com/tags/alm/"/>
    
      <category term="devops" scheme="http://www.westerndevs.com/tags/devops/"/>
    
  </entry>
  
  <entry>
    <title type="html">Doing Snapshots on Azure Virtual Machines</title>
    <link href="http://www.westerndevs.com//azure-snapshots/" rel="alternate" type="text/html"/>
    <id>http://www.westerndevs.com//azure-snapshots/</id>
    <published>2015-11-04T06:30:00.000Z</published>
    <updated>2017-05-18T21:09:05.000Z</updated>
	<author>
	
	  
	  <name>Dylan Smith</name>
	  <email>optikal@shaw.ca</email>
	
	  <uri>http://www.westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>I've always been frustrated that I can't do snapshots when I'm using VM's in Azure. Especially when I'm developing some deployment automation, I like to be able to try something out - and when it inevitably screws up - reset the VM to a snapshot and try again.</p><a id="more"></a><p>We still can't do actual snapshots, but I've written some powershell that achieves the same goal.  It will grab a copy of the VHD file (this acts as the snapshot), then when we want to restore to snapshot we'll just swap out the VHD's.  The trick here is that Azure won't let you swap out the VHD for an existing VM, so we need to actually destroy the VM, swap out the VHD's, then recreate the VM using the existing VHD.</p><blockquote><p>Note: This is all done using ARM (Azure Resource Manager) style VM's.</p></blockquote><p>If you want to try it out, here's a step-by-step to try it out:</p><p>First create a VM in Azure, and be sure to select Resource Manager as the deployment model:</p><p><img src="http://i.imgur.com/waHMXxG.png" alt="Create ARM VM"></p><p><img src="http://i.imgur.com/601dKeE.png" alt="VM Basics"></p><p><img src="http://i.imgur.com/EjdOOxL.png" alt="Select VM Size"></p><p><img src="http://i.imgur.com/05cF86c.png" alt="VM Settings"></p><p>After it's done processing we'll have a new Resource Group with 6 resources included:</p><p><img src="http://i.imgur.com/QKLize8.png" alt="Resource Group"></p><p>One thing I like to do - that the wizard doesn't let you specify - is to assign a DNS name to the public IP that I'll use to connect to my VM.  You can set this in the configuration page for the Public IP resource.</p><p><img src="http://i.imgur.com/psVa4XE.png" alt="Set DNS"></p><p>Lastly, I need to copy the Storage Account Access Key for use in the powershell.</p><p><img src="http://i.imgur.com/yh9cgcp.png" alt="Retrieve Storage Key"></p><p>Now all we need to do is take the powershell below, and modify the values of the variables at the start to match the names you used when you created the VM/Resource Group.</p><p>The first time you run the script it will create the initial snapshot.  All subsequent times you run the script it will reset it to that snapshot.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Set variable values</span></div><div class="line"><span class="variable">$resourceGroupName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$location</span> = <span class="string">"West US"</span></div><div class="line"><span class="variable">$vmName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$vmSize</span> = <span class="string">"Standard_D1"</span></div><div class="line"><span class="variable">$vnetName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$nicName</span> = <span class="string">"dylandemo665"</span></div><div class="line"><span class="variable">$dnsName</span> = <span class="string">"dylandemo"</span></div><div class="line"><span class="variable">$diskName</span> = <span class="string">"DylanDemo"</span></div><div class="line"><span class="variable">$storageAccount</span> = <span class="string">"dylandemo"</span></div><div class="line"><span class="variable">$storageAccountKey</span> = <span class="string">"Enter Storage Key Here"</span></div><div class="line"><span class="variable">$subscriptionName</span> = <span class="string">"MSDN MPN"</span></div><div class="line"><span class="variable">$publicIpName</span> = <span class="string">"DylanDemo"</span></div><div class="line"></div><div class="line"><span class="variable">$diskBlob</span> = <span class="string">"<span class="variable">$diskName</span>.vhd"</span></div><div class="line"><span class="variable">$backupDiskBlob</span> = <span class="string">"<span class="variable">$diskName</span>-backup.vhd"</span></div><div class="line"><span class="variable">$vhdUri</span> = <span class="string">"https://<span class="variable">$storageAccount</span>.blob.core.windows.net/vhds/<span class="variable">$diskBlob</span>"</span></div><div class="line"><span class="variable">$subnetIndex</span> = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment"># login to Azure</span></div><div class="line">Add-AzureAccount</div><div class="line">Select-AzureSubscription -SubscriptionName <span class="variable">$subscriptionName</span></div><div class="line">Switch-AzureMode AzureResourceManager</div><div class="line"></div><div class="line"><span class="comment"># create backup disk if it doesn't exist</span></div><div class="line">Stop-AzureVM -ResourceGroupName <span class="variable">$resourceGroupName</span> -Name <span class="variable">$vmName</span> -Force -Verbose</div><div class="line"></div><div class="line"><span class="variable">$ctx</span> = New-AzureStorageContext -StorageAccountName <span class="variable">$storageAccount</span> -StorageAccountKey <span class="variable">$storageAccountKey</span></div><div class="line"><span class="variable">$blobCount</span> = Get-AzureStorageBlob -Container vhds -Context <span class="variable">$ctx</span> | where &#123; <span class="variable">$_</span>.Name <span class="nomarkup">-eq</span> <span class="variable">$backupDiskBlob</span> &#125; | Measure | % &#123; <span class="variable">$_</span>.Count &#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$blobCount</span> <span class="nomarkup">-eq</span> <span class="number">0</span>)</div><div class="line">&#123;</div><div class="line">  <span class="variable">$copy</span> = Start-AzureStorageBlobCopy -SrcBlob <span class="variable">$diskBlob</span> -SrcContainer <span class="string">"vhds"</span> -DestBlob <span class="variable">$backupDiskBlob</span> -DestContainer <span class="string">"vhds"</span> -Context <span class="variable">$ctx</span> -Verbose</div><div class="line">  <span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line">  <span class="variable">$status</span> </div><div class="line"></div><div class="line">  <span class="keyword">While</span>(<span class="variable">$status</span>.Status <span class="nomarkup">-eq</span> <span class="string">"Pending"</span>)&#123;</div><div class="line">    <span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line">    <span class="built_in">Start-Sleep</span> <span class="number">10</span></div><div class="line">    <span class="variable">$status</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># delete VM</span></div><div class="line">Remove-AzureVM -ResourceGroupName <span class="variable">$resourceGroupName</span> -Name <span class="variable">$vmName</span> -Force -Verbose</div><div class="line">Remove-AzureStorageBlob -Blob <span class="variable">$diskBlob</span> -Container <span class="string">"vhds"</span> -Context <span class="variable">$ctx</span> -Verbose</div><div class="line">Remove-AzureNetworkInterface -Name <span class="variable">$nicName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -Force -Verbose</div><div class="line">Remove-AzurePublicIpAddress -Name <span class="variable">$publicIpName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -Force -Verbose</div><div class="line"></div><div class="line"><span class="comment"># copy backup disk</span></div><div class="line"><span class="variable">$copy</span> = Start-AzureStorageBlobCopy -SrcBlob <span class="variable">$backupDiskBlob</span> -SrcContainer <span class="string">"vhds"</span> -DestBlob <span class="variable">$diskBlob</span> -DestContainer <span class="string">"vhds"</span> -Context <span class="variable">$ctx</span> -Verbose</div><div class="line"><span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line"><span class="variable">$status</span> </div><div class="line"></div><div class="line"><span class="keyword">While</span>(<span class="variable">$status</span>.Status <span class="nomarkup">-eq</span> <span class="string">"Pending"</span>)&#123;</div><div class="line">  <span class="variable">$status</span> = <span class="variable">$copy</span> | Get-AzureStorageBlobCopyState </div><div class="line">  <span class="built_in">Start-Sleep</span> <span class="number">10</span></div><div class="line">  <span class="variable">$status</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># recreate VM</span></div><div class="line"><span class="variable">$vnet</span> = Get-AzurevirtualNetwork -Name <span class="variable">$vnetName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span></div><div class="line"></div><div class="line"><span class="variable">$pip</span> = New-AzurePublicIpAddress -Name <span class="variable">$publicIpName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -DomainNameLabel <span class="variable">$dnsName</span> -Location <span class="variable">$location</span> -AllocationMethod Dynamic -Verbose</div><div class="line"><span class="variable">$nic</span> = New-AzureNetworkInterface -Name <span class="variable">$nicName</span> -ResourceGroupName <span class="variable">$resourceGroupName</span> -Location <span class="variable">$location</span> -SubnetId <span class="variable">$vnet</span>.Subnets[<span class="variable">$subnetIndex</span>].Id -PublicIpAddressId <span class="variable">$pip</span>.Id -Verbose</div><div class="line"><span class="variable">$vm</span> = New-AzureVMConfig -VMName <span class="variable">$vmName</span> -VMSize <span class="variable">$vmSize</span></div><div class="line"><span class="variable">$vm</span> = Add-AzureVMNetworkInterface -VM <span class="variable">$vm</span> -Id <span class="variable">$nic</span>.Id</div><div class="line"><span class="variable">$vm</span> = Set-AzureVMOSDisk -VM <span class="variable">$vm</span> -Name <span class="variable">$diskName</span> -VhdUri <span class="variable">$vhdUri</span> -CreateOption attach -Windows</div><div class="line"></div><div class="line">New-AzureVM -ResourceGroupName <span class="variable">$resourceGroupName</span> -Location <span class="variable">$location</span> -VM <span class="variable">$vm</span> -Verbose</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I&#39;ve always been frustrated that I can&#39;t do snapshots when I&#39;m using VM&#39;s in Azure. Especially when I&#39;m developing some deployment automation, I like to be able to try something out - and when it inevitably screws up - reset the VM to a snapshot and try again.&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title type="html">Using Azure ARM to Deploy a Docker Container</title>
    <link href="http://www.westerndevs.com//using-azure-arm-to-deploy-a-docker-container/" rel="alternate" type="text/html"/>
    <id>http://www.westerndevs.com//using-azure-arm-to-deploy-a-docker-container/</id>
    <published>2015-08-24T23:13:00.000Z</published>
    <updated>2017-05-18T21:09:05.000Z</updated>
	<author>
	
	  
	  <name>Dylan Smith</name>
	  <email>optikal@shaw.ca</email>
	
	  <uri>http://www.westerndevs.com</uri>
	</author>
    
    <content type="html"><![CDATA[<p>If you’ve been following the WesternDevs blog you’ll have seen a few posts lately about our adventures with infrastructure for our blog with Jekyll/Docker.</p><a id="more"></a><ul><li><a href="http://www.westerndevs.com/docker-on-windows-10-problems/">Docker on Windows 10 Problems</a></li><li><a href="http://www.westerndevs.com/getting-docker-running-on-windows-10/">Getting Docker Running on Windows 10</a></li><li><a href="http://www.westerndevs.com/docker-and-western-devs/">Docker and Western Devs</a></li></ul><p>We decided to use Jekyll to host our blog, which most of us had never used before.  All of us need a way to fire up a Jekyll instance to test our changes (even simple things like how a new post will render).  Jekyll is really made for Linux, and most of us run Windows.  Although <a href="http://jekyll-windows.juthilo.com/" target="_blank" rel="external">Jekyll can run on windows in theory</a>, we have struggled to get it to work.  Amir came to the rescue, and created a <a href="https://hub.docker.com/r/abarylko/western-devs/" target="_blank" rel="external">Docker image that includes Jekyll</a> configured according to our needs.</p><p>Now we have a new problem – most of us haven’t used Docker before.  We had some struggles, just getting Docker up and running and configured on Windows took a little bit of work for those of us that hadn’t used it before.  Those of us using Windows 10 discovered there were [additional challenges getting Docker running](Docker on Windows 10 Problems).  And for me personally, I do all my work in VM’s (either local VM’s, or Azure VM’s) and I didn’t want to install Docker/VirtualBox on my host OS, and I discovered that you can’t install Docker/VBox inside a Hyper-V Windows VM.</p><p>I decided I was going to get something running in Azure, and I had an additional goal of making what I did repeatable and automated so that my fellow Western Devs could easily do what I did.  I’ve been doing <em>a lot</em> of work with Azure ARM Templates lately, so that was the approach I took.  I noticed there is a pre-existing image with Ubuntu available, and there is a Docker VM Extension that you can apply during provisioning that will install/configure Docker, and it can use Docker Compose to spin up one or more containers too.</p><p>I created the JSON ARM Template, and a simple PowerShell script to deploy it.  Now any of my fellow WesternDevs can simply run a PS1 script, get prompted for a few pieces of info (azure credentials, azure subscription, github branch name, resource group name), and ~10 mins later they will have a new VM in Azure, with Docker installed, our WesternDevs image deployed, and our Jekyll site up and running with the code from their branch.  Then they can bring it up in a web browser and test out their changes before merging with Master.  When they’re done they can delete the Azure resource group if they wish, or keep it around for future testing.</p><h2>The Gory Details</h2><p>If you’ve never used Azure ARM Templates before, it’s a JSON file that describes a set of Azure Resources and their configurations.  You can use a PowerShell cmdlet to give the JSON to Azure, and it will spin up a new Resource Group and a bunch of new resources based on what is described in the JSON.  For the WesternDevs template the JSON describes the following resources:</p><ul><li>Storage Account</li><li>Public IP Address</li><li>Virtual Network</li><li>Network Interface</li><li>Network Security Group</li><li>Virtual Machine</li><li>VM Extension – DockerExtension</li></ul><p>The full JSON file is included at the end of this post.  It can also be <a href="https://github.com/westerndevs/western-devs-website/tree/source/_azure" target="_blank" rel="external">found on GitHub</a>.  Some of the configuration that is described in the JSON template includes:</p><ul><li>The Network Security Group exposes port 22 for SSH, and port 4000 for HTTP (this is what our Jekyll/Docker is configured to use)</li><li>The VM is created from an image in the Azure Gallery provided by Canonical that has Ubuntu 15.04 on it.</li></ul><p>VM Extensions are additional components that can be applied to your VM as part of the provisioning process.  There is an extension available called DockerExtension that will install and configure Docker for you as part of the provisioning process.  Here is the relevant part of the template:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"type"</span>: <span class="string">"Microsoft.Compute/virtualMachines/extensions"</span>,</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"[concat(variables('vmName'),'/', variables('extensionName'))]"</span>,</div><div class="line">  <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">  <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">  <span class="attr">"dependsOn"</span>: [</div><div class="line">    <span class="string">"[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"</span></div><div class="line">  ],</div><div class="line">  <span class="attr">"properties"</span>: &#123;</div><div class="line">    <span class="attr">"publisher"</span>: <span class="string">"Microsoft.Azure.Extensions"</span>,</div><div class="line">    <span class="attr">"type"</span>: <span class="string">"DockerExtension"</span>,</div><div class="line">    <span class="attr">"typeHandlerVersion"</span>: <span class="string">"1.0"</span>,</div><div class="line">    <span class="attr">"autoUpgradeMinorVersion"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"compose"</span>: &#123;</div><div class="line">        <span class="attr">"wddocker"</span>: &#123;</div><div class="line">          <span class="attr">"image"</span>: <span class="string">"abarylko/western-devs:v1"</span>,</div><div class="line">          <span class="attr">"ports"</span>: [</div><div class="line">            <span class="string">"4000:4000"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"stdin_open"</span>: <span class="literal">true</span>,</div><div class="line">          <span class="attr">"command"</span>: <span class="string">"[concat('bash -c \"git clone https://github.com/westerndevs/western-devs-website.git &amp;&amp; cd western-devs-website &amp;&amp; git checkout ', parameters('branchName'), ' &amp;&amp; sed -i s/www.westerndevs.com/', variables('dnsNameForPublicIP'), '.westus.cloudapp.azure.com:4000/g _config.yml &amp;&amp; bundle install &amp;&amp; jekyll serve --host 0.0.0.0 --force_polling\"')]"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>This tells it to apply the DockerExtension to the VM previously created.  Additionally it uses Docker Compose to allow you to specify one or more Docker containers that it will pull down from DockerHub, deploy into Docker, allow you to specify configuration such as ports to map to the host, and allow you to run command(s) on the docker image.</p><p>In the template above we tell it to grab the Docker image abarylko/western-devs:v1 which was created by my friend <a href="http://www.westerndevs.com/bios/amir_barylko/">Amir Barylko</a> and already has Jekyll installed.  Then we tell it to map port 4000 from the docker container to port 4000 on the host Linux VM.  Lastly we give it a few bash commands to run on the docker container when it starts up:</p><ul><li>git clone https://github.com/westerndevs/western-devs-website.git</li><li>cd western-devs-website</li><li>git checkout [branchName]</li><li>sed –i s/www.westerndevs.com/[VmDns].westus.cloudapp.azure.com:4000/g _config.yml</li><li>bundle install</li><li>jekyll serve –host 0.0.0.0 –force_polling</li></ul><p>This will grab the github repo in to the docker container, checkout our branch that we want to test (the branch name is passed as a parameter into the ARM template as we’ll see below in the Powershell), update the _config.yml file (which is a config file Jekyll uses) to replace the public url with the URL for our Azure VM (so when we test the site, the links all point to the same testing site URL), use bundle to install all our gems, then fire up Jekyll to run our site.</p><p>Now that we have a JSON file that describes our Azure Resources, we need a way to deploy this.  This is a simple bit of PowerShell.  My goal here was to make this as simple as possible for somebody to use, even if they aren’t comfortable with PowerShell/Azure/Docker/Linux/Jekyll/etc.  It’s as simple as running the PS1, being prompted for 4 things (new resource group name, github branch name, azure login, azure subscription), then waiting ~10 mins for Azure to do it’s thing.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$EnvName</span> = <span class="built_in">Read-Host</span> <span class="string">"Name for Azure Resource Group (must be globally unique)?"</span></div><div class="line"><span class="variable">$BranchName</span> = <span class="built_in">Read-Host</span> <span class="string">"Name of branch in git?"</span></div><div class="line"></div><div class="line">Add-AzureAccount | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$AllSubscriptions</span> = Get-AzureSubscription</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$AllSubscriptions</span>.Count <span class="nomarkup">-eq</span> <span class="number">1</span>)</div><div class="line">&#123;</div><div class="line">    Select-AzureSubscription <span class="variable">$AllSubscriptions</span>[<span class="number">0</span>].SubscriptionName</div><div class="line">    <span class="built_in">Write-Host</span> (<span class="string">"Only 1 Azure Subscription found. Using "</span> + <span class="variable">$AllSubscriptions</span>[<span class="number">0</span>].SubscriptionName)</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    <span class="variable">$AzureSub</span> = <span class="variable">$AllSubscriptions</span> | <span class="built_in">Out-GridView</span> -Title <span class="string">"Select Azure Subscription"</span> -PassThru</div><div class="line">    Select-AzureSubscription <span class="variable">$AzureSub</span>.SubscriptionName</div><div class="line">&#125;</div><div class="line"></div><div class="line">Switch-AzureMode AzureResourceManager</div><div class="line"></div><div class="line"><span class="variable">$TemplateFile</span> = <span class="built_in">Join-Path</span> <span class="variable">$PSScriptRoot</span> <span class="string">"wddocker.json"</span></div><div class="line"><span class="variable">$params</span> = @&#123;branchName=<span class="string">"<span class="variable">$BranchName</span>"</span>&#125;</div><div class="line">New-AzureResourceGroup -Location <span class="string">"West US"</span> -Name <span class="variable">$EnvName</span> -TemplateFile <span class="variable">$TemplateFile</span> -TemplateParameterObject <span class="variable">$params</span> -verbose</div><div class="line"></div><div class="line"><span class="built_in">Write-Host</span> <span class="string">"Your site will be available at this URL: http://<span class="variable">$EnvName</span>.westus.cloudapp.azure.com:4000"</span></div><div class="line"><span class="built_in">Read-Host</span> <span class="string">"Press enter to launch a browser to your new site - if it gives an error wait a minute then refresh"</span></div><div class="line"><span class="built_in">Start-Process</span> <span class="string">"http://<span class="variable">$EnvName</span>.westus.cloudapp.azure.com:4000"</span></div><div class="line"></div><div class="line"><span class="built_in">Write-Host</span> <span class="string">"When you're finished testing you should delete the Azure Resource Group"</span></div><div class="line"><span class="built_in">Write-Host</span> <span class="string">"You can do it yourself in portal.azure.com"</span></div><div class="line"><span class="built_in">Write-Host</span> <span class="string">"Or in PS using Remove-AzureResourceGroup -Name <span class="variable">$EnvName</span>"</span></div><div class="line"><span class="built_in">Write-Host</span> <span class="string">"Or this script can do it for you automatically (leave this open until done testing)"</span></div><div class="line"><span class="built_in">Write-Host</span> <span class="string">""</span></div><div class="line"><span class="variable">$DeleteRG</span> = <span class="built_in">Read-Host</span> <span class="string">"Do you want to delete the Azure Resource Group <span class="variable">$EnvName</span> now (y/n)?"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="variable">$DeleteRG</span>.ToUpper() <span class="nomarkup">-eq</span> <span class="string">"Y"</span>)</div><div class="line">&#123;</div><div class="line">    Remove-AzureResourceGroup -Name <span class="variable">$EnvName</span> -Force -Verbose</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">Read-Host</span> <span class="string">"Press enter to close this window"</span></div></pre></td></tr></table></figure><p>The interesting line here is the one that does New-AzureResourceGroup.  That passes the JSON template to azure and tells it to create a new resource group and provision the resources described in the template.  We also tell it the azure datacenter location where everything should be created, and pass in a parameter that contains the branch name.</p><p>The rest of the script is just collecting some values from the user, and at the end it will launch your browser to the newly created site, and give you the option to delete all the azure resources just created if you wish.</p><h2>Try it for Yourself</h2><p>You can easily give this a try yourself.</p><ol><li><a href="https://github.com/westerndevs/western-devs-website/tree/source/_azure" target="_blank" rel="external">Download wddocker.json and deploy.ps1 from github</a></li><li>If you haven’t already you need to install azure powershell. You can get the installer in the <a href="https://github.com/westerndevs/western-devs-website/tree/source/_azure" target="_blank" rel="external">github folder</a>, or <a href="https://azure.microsoft.com/en-us/documentation/articles/powershell-install-configure/" target="_blank" rel="external">from Microsoft</a></li><li>Run deploy.ps1</li><li>When prompted for branch name use: source</li><li>???</li><li>Profit!!!</li></ol><p><img src="http://i.imgur.com/xfiW4Ta.png" alt="ARM Deployment"></p><h2>Complete ARM Template JSON</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"$schema"</span>: <span class="string">"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"</span>,</div><div class="line">  <span class="attr">"contentVersion"</span>: <span class="string">"1.0.0.0"</span>,</div><div class="line">  <span class="attr">"parameters"</span>: &#123;</div><div class="line">    <span class="attr">"branchName"</span>: &#123;</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</div><div class="line">  <span class="attr">"defaultValue"</span>: <span class="string">"source"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"variables"</span>: &#123;</div><div class="line"><span class="attr">"newStorageAccountName"</span>: <span class="string">"[toLower(resourceGroup().name)]"</span>,</div><div class="line"><span class="attr">"location"</span>: <span class="string">"[resourceGroup().location]"</span>,</div><div class="line"><span class="attr">"adminUsername"</span>: <span class="string">"WesternDevs"</span>,</div><div class="line"><span class="attr">"adminPassword"</span>: <span class="string">"P2ssw0rd"</span>,</div><div class="line"><span class="attr">"dnsNameForPublicIP"</span>: <span class="string">"[toLower(resourceGroup().name)]"</span>,</div><div class="line">    <span class="attr">"imagePublisher"</span>: <span class="string">"Canonical"</span>,</div><div class="line">    <span class="attr">"imageOffer"</span>: <span class="string">"UbuntuServer"</span>,</div><div class="line">    <span class="attr">"ubuntuOSVersion"</span>: <span class="string">"15.04"</span>,</div><div class="line">    <span class="attr">"OSDiskName"</span>: <span class="string">"[resourceGroup().name]"</span>,</div><div class="line">    <span class="attr">"nsgName"</span>: <span class="string">"myNSG"</span>,</div><div class="line">    <span class="attr">"nicName"</span>: <span class="string">"myVMNic"</span>,</div><div class="line">    <span class="attr">"extensionName"</span>: <span class="string">"DockerExtension"</span>,</div><div class="line">    <span class="attr">"addressPrefix"</span>: <span class="string">"10.0.0.0/16"</span>,</div><div class="line">    <span class="attr">"subnetName"</span>: <span class="string">"Subnet"</span>,</div><div class="line">    <span class="attr">"subnetPrefix"</span>: <span class="string">"10.0.0.0/24"</span>,</div><div class="line">    <span class="attr">"storageAccountType"</span>: <span class="string">"Standard_LRS"</span>,</div><div class="line">    <span class="attr">"publicIPAddressName"</span>: <span class="string">"myPublicIP"</span>,</div><div class="line">    <span class="attr">"publicIPAddressType"</span>: <span class="string">"Dynamic"</span>,</div><div class="line">    <span class="attr">"vmStorageAccountContainerName"</span>: <span class="string">"vhds"</span>,</div><div class="line">    <span class="attr">"vmName"</span>: <span class="string">"[resourceGroup().name]"</span>,</div><div class="line">    <span class="attr">"vmSize"</span>: <span class="string">"Basic_A1"</span>,</div><div class="line">    <span class="attr">"virtualNetworkName"</span>: <span class="string">"MyVNET"</span>,</div><div class="line">    <span class="attr">"vnetID"</span>: <span class="string">"[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]"</span>,</div><div class="line">    <span class="attr">"nsgID"</span>: <span class="string">"[resourceId('Microsoft.Network/networkSecurityGroups',variables('nsgName'))]"</span>,</div><div class="line">    <span class="attr">"subnetRef"</span>: <span class="string">"[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"resources"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Storage/storageAccounts"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[variables('newStorageAccountName')]"</span>,</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"accountType"</span>: <span class="string">"[variables('storageAccountType')]"</span></div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Network/publicIPAddresses"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[variables('publicIPAddressName')]"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"publicIPAllocationMethod"</span>: <span class="string">"[variables('publicIPAddressType')]"</span>,</div><div class="line">        <span class="attr">"dnsSettings"</span>: &#123;</div><div class="line">          <span class="attr">"domainNameLabel"</span>: <span class="string">"[variables('dnsNameForPublicIP')]"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Network/virtualNetworks"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[variables('virtualNetworkName')]"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"dependsOn"</span>: [</div><div class="line">        <span class="string">"[variables('nsgID')]"</span></div><div class="line">      ],</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"addressSpace"</span>: &#123;</div><div class="line">          <span class="attr">"addressPrefixes"</span>: [</div><div class="line">            <span class="string">"[variables('addressPrefix')]"</span></div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"subnets"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"name"</span>: <span class="string">"[variables('subnetName')]"</span>,</div><div class="line">            <span class="attr">"properties"</span>: &#123;</div><div class="line">              <span class="attr">"addressPrefix"</span>: <span class="string">"[variables('subnetPrefix')]"</span>,</div><div class="line">              <span class="attr">"networkSecurityGroup"</span>: &#123;</div><div class="line">                <span class="attr">"id"</span>: <span class="string">"[variables('nsgID')]"</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Network/networkInterfaces"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[variables('nicName')]"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"dependsOn"</span>: [</div><div class="line">        <span class="string">"[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"</span>,</div><div class="line">        <span class="string">"[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"</span></div><div class="line">      ],</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"ipConfigurations"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"name"</span>: <span class="string">"ipconfig1"</span>,</div><div class="line">            <span class="attr">"properties"</span>: &#123;</div><div class="line">              <span class="attr">"privateIPAllocationMethod"</span>: <span class="string">"Dynamic"</span>,</div><div class="line">              <span class="attr">"publicIPAddress"</span>: &#123;</div><div class="line">                <span class="attr">"id"</span>: <span class="string">"[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"</span></div><div class="line">              &#125;,</div><div class="line">              <span class="attr">"subnet"</span>: &#123;</div><div class="line">                <span class="attr">"id"</span>: <span class="string">"[variables('subnetRef')]"</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Network/networkSecurityGroups"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[variables('nsgName')]"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"securityRules"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"name"</span>: <span class="string">"http"</span>,</div><div class="line">            <span class="attr">"properties"</span>: &#123;</div><div class="line">              <span class="attr">"description"</span>: <span class="string">"Allow HTTP"</span>,</div><div class="line">              <span class="attr">"protocol"</span>: <span class="string">"Tcp"</span>,</div><div class="line">              <span class="attr">"sourcePortRange"</span>: <span class="string">"*"</span>,</div><div class="line">              <span class="attr">"destinationPortRange"</span>: <span class="string">"4000"</span>,</div><div class="line">              <span class="attr">"sourceAddressPrefix"</span>: <span class="string">"Internet"</span>,</div><div class="line">              <span class="attr">"destinationAddressPrefix"</span>: <span class="string">"*"</span>,</div><div class="line">              <span class="attr">"access"</span>: <span class="string">"Allow"</span>,</div><div class="line">              <span class="attr">"priority"</span>: <span class="number">100</span>,</div><div class="line">              <span class="attr">"direction"</span>: <span class="string">"Inbound"</span></div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"name"</span>: <span class="string">"ssh"</span>,</div><div class="line">            <span class="attr">"properties"</span>: &#123;</div><div class="line">              <span class="attr">"description"</span>: <span class="string">"Allow SSH"</span>,</div><div class="line">              <span class="attr">"protocol"</span>: <span class="string">"Tcp"</span>,</div><div class="line">              <span class="attr">"sourcePortRange"</span>: <span class="string">"*"</span>,</div><div class="line">              <span class="attr">"destinationPortRange"</span>: <span class="string">"22"</span>,</div><div class="line">              <span class="attr">"sourceAddressPrefix"</span>: <span class="string">"Internet"</span>,</div><div class="line">              <span class="attr">"destinationAddressPrefix"</span>: <span class="string">"*"</span>,</div><div class="line">              <span class="attr">"access"</span>: <span class="string">"Allow"</span>,</div><div class="line">              <span class="attr">"priority"</span>: <span class="number">110</span>,</div><div class="line">              <span class="attr">"direction"</span>: <span class="string">"Inbound"</span></div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Compute/virtualMachines"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[variables('vmName')]"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"dependsOn"</span>: [</div><div class="line">        <span class="string">"[concat('Microsoft.Storage/storageAccounts/', variables('newStorageAccountName'))]"</span>,</div><div class="line">        <span class="string">"[concat('Microsoft.Network/networkInterfaces/', variables('nicName'))]"</span></div><div class="line">      ],</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"hardwareProfile"</span>: &#123;</div><div class="line">          <span class="attr">"vmSize"</span>: <span class="string">"[variables('vmSize')]"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"osProfile"</span>: &#123;</div><div class="line">          <span class="attr">"computername"</span>: <span class="string">"[variables('vmName')]"</span>,</div><div class="line">          <span class="attr">"adminUsername"</span>: <span class="string">"[variables('adminUsername')]"</span>,</div><div class="line">          <span class="attr">"adminPassword"</span>: <span class="string">"[variables('adminPassword')]"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"storageProfile"</span>: &#123;</div><div class="line">          <span class="attr">"imageReference"</span>: &#123;</div><div class="line">            <span class="attr">"publisher"</span>: <span class="string">"[variables('imagePublisher')]"</span>,</div><div class="line">            <span class="attr">"offer"</span>: <span class="string">"[variables('imageOffer')]"</span>,</div><div class="line">            <span class="attr">"sku"</span>: <span class="string">"[variables('ubuntuOSVersion')]"</span>,</div><div class="line">            <span class="attr">"version"</span>: <span class="string">"latest"</span></div><div class="line">          &#125;,</div><div class="line">          <span class="attr">"osDisk"</span>: &#123;</div><div class="line">            <span class="attr">"name"</span>: <span class="string">"osdisk1"</span>,</div><div class="line">            <span class="attr">"vhd"</span>: &#123;</div><div class="line">              <span class="attr">"uri"</span>: <span class="string">"[concat('http://',variables('newStorageAccountName'),'.blob.core.windows.net/',variables('vmStorageAccountContainerName'),'/',variables('OSDiskName'),'.vhd')]"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"caching"</span>: <span class="string">"ReadWrite"</span>,</div><div class="line">            <span class="attr">"createOption"</span>: <span class="string">"FromImage"</span></div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"networkProfile"</span>: &#123;</div><div class="line">          <span class="attr">"networkInterfaces"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"Microsoft.Compute/virtualMachines/extensions"</span>,</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"[concat(variables('vmName'),'/', variables('extensionName'))]"</span>,</div><div class="line">      <span class="attr">"apiVersion"</span>: <span class="string">"2015-05-01-preview"</span>,</div><div class="line">      <span class="attr">"location"</span>: <span class="string">"[variables('location')]"</span>,</div><div class="line">      <span class="attr">"dependsOn"</span>: [</div><div class="line">        <span class="string">"[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"</span></div><div class="line">      ],</div><div class="line">      <span class="attr">"properties"</span>: &#123;</div><div class="line">        <span class="attr">"publisher"</span>: <span class="string">"Microsoft.Azure.Extensions"</span>,</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"DockerExtension"</span>,</div><div class="line">        <span class="attr">"typeHandlerVersion"</span>: <span class="string">"1.0"</span>,</div><div class="line">        <span class="attr">"autoUpgradeMinorVersion"</span>: <span class="literal">true</span>,</div><div class="line"><span class="attr">"settings"</span>: &#123;</div><div class="line">          <span class="attr">"compose"</span>: &#123;</div><div class="line">            <span class="attr">"wddocker"</span>: &#123;</div><div class="line">              <span class="attr">"image"</span>: <span class="string">"abarylko/western-devs:v1"</span>,</div><div class="line">              <span class="attr">"ports"</span>: [</div><div class="line">                <span class="string">"4000:4000"</span></div><div class="line">              ],</div><div class="line">  <span class="attr">"stdin_open"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">"command"</span>: <span class="string">"[concat('bash -c \"git clone https://github.com/westerndevs/western-devs-website.git &amp;&amp; cd western-devs-website &amp;&amp; git checkout ', parameters('branchName'), ' &amp;&amp; sed -i s/www.westerndevs.com/', variables('dnsNameForPublicIP'), '.westus.cloudapp.azure.com:4000/g _config.yml &amp;&amp; bundle install &amp;&amp; jekyll serve --host 0.0.0.0 --force_polling\"')]"</span></div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">&#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;If you’ve been following the WesternDevs blog you’ll have seen a few posts lately about our adventures with infrastructure for our blog with Jekyll/Docker.&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
</feed>
