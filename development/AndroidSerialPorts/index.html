<!DOCTYPE html>
<html lang="en" xml:lang="en">

  <head>
  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>The Great RS-232 Adventure | Western Devs</title>
  <meta name="description" content="Talking over the RS-232 serial protocol is a bit of a blast from the past but I needed to use in on an Android tablet from within Xamarin. This is the, painfully complete, story of my journey.">
<meta name="keywords" content="c#,xamarin">
<meta property="og:type" content="article">
<meta property="og:title" content="The Great RS-232 Adventure">
<meta property="og:url" content="http://www.westerndevs.com/development/AndroidSerialPorts/index.html">
<meta property="og:site_name" content="Western Devs">
<meta property="og:description" content="Talking over the RS-232 serial protocol is a bit of a blast from the past but I needed to use in on an Android tablet from within Xamarin. This is the, painfully complete, story of my journey.">
<meta property="og:image" content="http://imgur.com/WQlOjce.png">
<meta property="og:image" content="http://i.imgur.com/co21I7x.jpg">
<meta property="og:image" content="http://i.imgur.com/urrU3hU.jpg">
<meta property="og:updated_time" content="2017-05-18T21:09:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Great RS-232 Adventure">
<meta name="twitter:description" content="Talking over the RS-232 serial protocol is a bit of a blast from the past but I needed to use in on an Android tablet from within Xamarin. This is the, painfully complete, story of my journey.">
<meta name="twitter:image" content="http://imgur.com/WQlOjce.png">
<meta name="twitter:creator" content="@westerndevs">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="title" content="WesternDevs">   
    <meta name="keywords" content="software development,software,asp.net,blog">
    <meta name="description" content="We're all west of somewhere">
    <meta name="copyright" content="WesternDevs">
    <meta name="revisit-after" content="15 days">
    <meta name="robots" content="all">
    <meta name="MSSmartTagsPreventParsing" content="true">
  
    <link rel="alternate" href="/feed" title="Western Devs" type="application/atom+xml">
  
  <link rel="stylesheet" href="/css/style.css">
      
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>  
  </head>

<body>

<!-- FIXED HEADER BECAUSE SCROLLING -->
<!--HEADER STARTS-->
<div class="WrapperHeader">
<div style="display:inline-block; text-align: center;">
<div class="Header">

  <div class="HeaderLogo">
    <a href="/"><img src="/images/header_logo_transparent.png" alt="WesternDevs" title="WesternDevs" border="0" style="width: 206px; height: 64px;" width="206" height="64"></a>
  </div>

  <div class="HeaderLinks">
      <a href="/posts" class="nav">POSTS</a>       
      <a href="/podcasts" class="nav">PODCASTS</a>       
      <a href="/whoweare" class="nav">ABOUT</a>  
      <a href="/whatwevedone" class="nav">WHAT WE'VE DONE</a>  
      <a href="/speaking" class="nav">SPEAKING</a>
      <div class="HeaderIcons">
        <a href="mailto:info@westerndevs.com"><img src="/images/icon_email.png" border="0" alt="Email" title="Email" height="26" width="26"></a>
        <a href="/feed"><img src="/images/icon_subscribe.png" border="0" alt="Subscribe" title="Subscribe" height="26" width="27"></a>
        <a href="http://twitter.com/westerndevs" target="_blank"><img src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter" height="26" width="27"></a>
        <a href="http://github.com/westerndevs" target="_blank"><img src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub" height="26" width="27"></a>     
      </div>
  </div>
  
</div>
</div>
</div>
<!--HEADER ENDS-->    



<!--WRAPPER STARTS-->
<div class="Wrapper" style="">

<!--SUBHEAD STARTS-->
<div class="WrapperSubHeaderSubpage">
<center>
	<div class="SubHeader">
		<H1 class="title"><img class="icon" src="/images/icon_posts.png" alt="POST" title="POST" border="0"> POST</H1>
	</div>
</center>
</div>
<!--SUBHEAD ENDS-->

<!--PAGE CONTENT STARTS-->
<center>
<div class="WrapperContent">

<!--MAIN CONTENT STARTS-->
	<div class="SubpageBoxSubLrg">
		<div class="SubpageBoxSubLrgContent">
		    <div class='postTitle'>
  <div class="ListLrgDateBG">
    <div class="ListLrgDateMonth">MAY</div>
    <div class="ListLrgDateDay">11</div>
    <div class="ListLrgDateYear">2017</div>
  </div>
  <h2>The Great RS-232 Adventure</h2>
</div>

		    

			<div id="mainPostContent">
	        <p>A few days back my buddy <a href="/bios/justin_self">Justin Self</a> found me a pretty good challenge. Although my memory isn't as good as it once was I have a high degree of confidence that the interaction went something like this.</p>
<p><strong>Scene:</strong> Simon has just walked out of the ocean after having swum between two adjacent tropical islands. As he strolls up to the beach Justin arrives.</p>
<p><img src="http://imgur.com/WQlOjce.png" alt="100% truthful representation of what it looked like">
<em>Photo of expensive and highly accurate recreation of what happened</em></p>
<p><strong>Justin:</strong> We need somebody to figure out how to get this android tablet to talk over serial to a computer.</p>
<p><strong>Simon:</strong> You mean over USB?</p>
<p><strong>Justin:</strong> No, over RS-232 serial. And you need to be able to do it in Xamarin's MonoDroid or Mono for Android or whatever non-copyright infringing name they have for it now.</p>
<p><strong>Simon:</strong> Well Justin, I've never used Xamarin before, nor have I written an Android app, nor have I ever done communication over a serial port before. I actually know nothing about hardware either.</p>
<p><strong>Justin:</strong> You're almost overqualified for this...</p>
<p><strong>Simon:</strong> I'm as qualified as I am to do anything. I'll get right on it - ship me the tablet.</p>
<p>And that is a very accurate representation of just what happened. My first step was to get the cables I needed. Back in 1996 I had a serial mouse but that fellow is long since gone and I haven't a single serial cable in my house. So I headed over to a local electronics store and threw myself at the mercy of the clerk and elderly electrical engineering type. He soon had me kitted out with all the hardware I needed</p>
<ul>
<li>ATEN USB to Serial converter</li>
<li>6ft straight through serial cable</li>
<li>F/F gender changer</li>
<li>Null modem adapter</li>
</ul>
<p>My computer didn't have an RS-232 port and neither did anything else in my house so the USB-to-serial converter was key. It installed using built in Windows drivers which was fortunate because the manual that came with it only had instructions for installing on Windows 2000. For the serial cable I took a straight through because I wasn't sure how the tablet was wired. The gender changer was needed to hook things together and the null modem adapter was to switch around the wiring for computer to computer communication. See back in the day you'd actually use different wires to connect two computers than to connect a computer and a mouse or printer or something. Twisted pair Ethernet use to be like that too before the gigabit standard introduced auto-switching.</p>
<p>A couple of days later a box arrived for me containing the tablet</p>
<p><img src="http://i.imgur.com/co21I7x.jpg" alt="Image of IoT-800 from http://www.ruggedpcreview.com/3_panels_arbor_iot800.html">
<em>Image from http://www.ruggedpcreview.com/3_panels_arbor_iot800.html</em></p>
<p>It was an Arbor IoT-800 running Android 4.4. As you can see in that picture there are two 9-pin serial ports on the bottom as well as USB ports and an Ethernet jack. A quick ProTip about those USB port: they aren't the sort you can use to hook the tablet up to your computer but rather for hooking up the tablet to external devices. You might be able to get them working for hooking up to a computer but you'd need a USB-crossover cable, which I didn't have and, honestly, I'd never heard of before this.</p>
<p>My first step was to write something on the Windows side that could talk over serial. I needed to find the COM port that was related to the serial port I had plugged in. To do this I called into the Windows Management Interface, WMI. You need to run as admin to do this*. I enumerated all the serial ports on my machine and picked the one whose name contained USB. I'm not sure what the other one is, possibly something built into the motherboard that doesn't have an external connector.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> searcher = <span class="keyword">new</span> ManagementObjectSearcher(<span class="string">"root\\WMI"</span>, <span class="string">"SELECT * FROM MSSerial_PortName"</span>);</div><div class="line"><span class="keyword">string</span> serialPortName = <span class="string">""</span>;</div><div class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> searchResult <span class="keyword">in</span> searcher.Get())</div><div class="line">&#123;</div><div class="line">    Console.Write(<span class="string">$"<span class="subst">&#123;searchResult[<span class="string">"InstanceName"</span>]&#125;</span> - <span class="subst">&#123;searchResult[<span class="string">"PortName"</span>]&#125;</span>"</span>);</div><div class="line">    <span class="keyword">if</span> (searchResult[<span class="string">"InstanceName"</span>].ToString().Contains(<span class="string">"USB"</span>))</div><div class="line">    &#123;</div><div class="line">        Console.Write(<span class="string">" &lt;--- using this one"</span>);</div><div class="line">        serialPortName = searchResult[<span class="string">"PortName"</span>].ToString();</div><div class="line">    &#125;</div><div class="line">    Console.WriteLine();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can also look in the device manager to see which COM port the device is on but this way is more portable. On my machine I got this output</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Starting</div><div class="line">ACPI\PNP0501\1_0 - COM1</div><div class="line">USB VID_0557&amp;PID_2008\6&amp;2c24ce2e&amp;0&amp;4_0 - COM4 --- using this one</div></pre></td></tr></table></figure>
<p>Next I needed to open up the port and write some data. Fortunately there is a built-in serial port library in .NET. Depending on which articles you read online the serial drivers might be terrible. I'm not overly concerned about performance on this line at this juncture so I just went with the built in class located in <code>System.IO.Ports</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> counter = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> serialPort = <span class="keyword">new</span> SerialPort(serialPortName, <span class="number">9600</span>);<span class="comment">//COM4 and baud of 9600bit/s to start, ramp up later</span></div><div class="line">serialPort.Open();</div><div class="line"><span class="keyword">while</span>(<span class="literal">true</span>)</div><div class="line">&#123;</div><div class="line">  Console.WriteLine(counter);</div><div class="line">  <span class="keyword">var</span> sendBytes = System.Text.ASCIIEncoding.ASCII.GetBytes(<span class="string">$"hello from the C# program<span class="subst">&#123;counter++&#125;</span>\n"</span>);</div><div class="line">  serialPort.Write(sendBytes, <span class="number">0</span>, sendBytes.Length);</div><div class="line">  Thread.Sleep(<span class="number">1000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here we just loop over the serial port and ask it to send data every second. I chose the most brutally simplistic things at first: a low baud rate and ASCII encoding.</p>
<p>Of course there really isn't a way to tell if this is working without having something on the other end to read it... So onto Android. My first stop was to install an SSH server on the machine. After all, this is UNIX system and I know that</p>
<p><img src="http://i.imgur.com/urrU3hU.jpg" alt="It's a UNIX system!"></p>
<p>One of the really cool things about Linux is the <code>/dev</code> directory. This directory contains all the devices on your system. So if you pop in there you might see devices like <code>sda0</code> which is actually a partition on your hard drive or <code>/dev/random</code> which is a fun device that just emits random numbers. Go on, try doing <code>cat /dev/random</code> or <code>cat /dev/urandom</code> depending on what your system has. On this IoT-800 there are a whole cluster of devices starting with <code>tty</code>. These are, comically, teletype devices. See back in the good old UNIX days we had dumb terminals for accessing a single computer and those devices showed up as <code>tty</code> devices. Guess how those terminals were connected. Serial. So after some experimentation I was able to figure out that the middle physical port on the device was mapped to <code>/dev/ttyS3</code>.</p>
<p>With the cables all hooked up I held my breath and ran <code>cat /dev/ttyS3</code> while the program on windows was running. Boom, there in my terminal was what was coming from Windows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">u0_a74@rk3188:/ $ cat /dev/ttyS3</div><div class="line">hello from the C# program0</div></pre></td></tr></table></figure>
<p>Linux is awesome. So now all that is needed it to get this working from Xamarin.</p>
<p>The System.IO.Ports package is not part of the version of .NET which runs on Android so a different approach was necessary. Again Linux to the rescue: we can simply read from the device. Before we do that, however, we need to set the baud on the connection. Normally you'd do this by using stty(1) but this command isn't available on Android and we likely wouldn't have permission to call it anyway.</p>
<p>What is needed is a native OS call to set up the serial port. Xamarin.Android allows calling to native C functions so let's do that.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">SetUpSerialSocket</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Opening serial port\n"</span>);</div><div class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/ttyS3"</span>, O_RDWR);</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">cfg</span>;</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Configuring serial port\n"</span>);</div><div class="line">    <span class="keyword">if</span> (tcgetattr(fd, &amp;cfg))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"tcgetattr() failed\n"</span>);</div><div class="line">        close(fd);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    cfmakeraw(&amp;cfg);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Setting speed in structure\n"</span>);</div><div class="line">    cfsetispeed(&amp;cfg, B115200);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Saving structure\n"</span>);</div><div class="line">    <span class="keyword">if</span>(!tcsetattr(fd, TCSANOW, &amp;cfg))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Serial port configured, mate\n"</span>);</div><div class="line">        close(fd);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Uh oh\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Setting baud on serial port /dev/ttyS3\n"</span>);</div><div class="line">    <span class="keyword">return</span> SetUpSerialSocket();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>To actually call this function we'll need to compile it. For that we need the Android NDK. Instead of getting into how to do that I'll just link to Nick Desaulniers's <a href="http://nickdesaulniers.github.io/blog/2016/07/01/android-cli/" target="_blank" rel="external">excellent post</a>. I will say that I did the compilation using the Windows Subsystem for Linux which is boss.</p>
<p>The end result is a libSetBaud.so file, .so being the extension for shared objects. This file should be included in the Android application in Visual Studio. A couple of things seem to be important here: first the file should be in a hierarchy which indicates what sort of processor it runs on. If you need to support more than one processor then you'll need to compile a couple of different versions of the library. I knew that this particular device had an armeabi-v7a so into that folder went the compiled .so file. Second you'll need to set the type on the file to AndroidNativeLibrary.</p>
<p>Next came exposing the function the function for use in Xamarin. To do that we use the Platform Invocation Service (PInvoke). PInvoke allows calling into unmanaged code in an easy way. All that is needed is to</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">SerialMessaging.Android</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaudSetter</span></div><div class="line">    &#123;</div><div class="line">        [DllImport(<span class="string">"libSetBaud"</span>, ExactSpelling = <span class="literal">true</span>)]</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">SetUpSerialSocket</span>(<span class="params"></span>)</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>I'd never had to do this before and it is actually surprisingly easy. Things obviously get way more complex if the function you're calling out to requires more complex types or pointers or file descriptors. I specifically kept the C code to a minimum because I don't trust in my ability to do things with C. If you're more adventurous then you can hook into the Android libraries and make use of things like their logging pipeline instead of <code>printf</code>.</p>
<p>With this all in place it was possible to spin up an Android application to see if we can get the message from the Windows side. Building on the idea of just reading from the device I started with</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> readHandle = File.Open(<span class="string">"/dev/ttyS3"</span>, FileMode.Open, FileAccess.Read, FileShare.ReadWrite);</div><div class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> readBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2000</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (readHandle.CanRead)</div><div class="line">        readHandle.Read(readBuffer, <span class="number">0</span>, <span class="number">2000</span>);</div><div class="line">    Android.Util.Log.Debug(<span class="string">"serial"</span>, readBuffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This was able to retrieve bytes out of the device and print them to the Android debug console. Awesome! The problem was that when they came in they weren't all a contiguous block. If the windows side sent <code>hello from the C# program1\n</code> in a loop then we might get the output</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hel</div><div class="line">lo from the C# </div><div class="line">program1\nh</div><div class="line">ello from the C# program1</div></pre></td></tr></table></figure>
<p>Uh oh. Guess we'll have to use a stop byte to indicate the end of messages. <code>0x00</code> won't work because the read buffer contains a bunch of those already. For now we can try using <code>0x01</code>. Looking at an ASCII table sending <code>0x03</code>, End of Text might be more appropriate. We add that to the send side with a WireFormatSerializer</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WireFormatSerializer</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span>[] <span class="title">Serialize</span>(<span class="params"><span class="keyword">string</span> toSerialize</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> bytes = System.Text.ASCIIEncoding.ASCII.GetBytes(toSerialize);</div><div class="line">        <span class="keyword">var</span> bytesWithSpaceForTerminatingCharacter = <span class="keyword">new</span> <span class="keyword">byte</span>[bytes.Length + <span class="number">1</span>];</div><div class="line">        Array.Copy(bytes, bytesWithSpaceForTerminatingCharacter, bytes.Length);</div><div class="line">        bytesWithSpaceForTerminatingCharacter[bytesWithSpaceForTerminatingCharacter.Length - <span class="number">1</span>] = <span class="number">0x1</span>;</div><div class="line">        <span class="keyword">return</span> bytesWithSpaceForTerminatingCharacter;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>On the receiving side we hook up a BufferedMessageReader whose responsibility it is to read bytes and assemble messages. I decided to push the boat out a bit here and implement an IObservable<string> which would rebuild the messages and emit them as events.</string></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class BufferedMessageReader : IObservable&lt;string&gt;</div><div class="line">&#123;</div><div class="line">    List&lt;IObserver&lt;string&gt;&gt; observers = new List&lt;IObserver&lt;string&gt;&gt;();</div><div class="line">    List&lt;byte&gt; freeBytes = new List&lt;byte&gt;();</div><div class="line"></div><div class="line">    public void AddBytes(byte[] bytes)</div><div class="line">    &#123;</div><div class="line">        foreach(var freeByte in bytes)</div><div class="line">        &#123;</div><div class="line">            if(freeByte == 0x01)</div><div class="line">            &#123;</div><div class="line">                EndOfMessageEncountered();</div><div class="line">            &#125;</div><div class="line">            else</div><div class="line">            &#123;</div><div class="line">                freeBytes.Add(freeByte);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public IDisposable Subscribe(IObserver&lt;string&gt; observer)</div><div class="line">    &#123;</div><div class="line">        if(!observers.Contains(observer))</div><div class="line">            observers.Add(observer);</div><div class="line">        return new Unsubscriber(observers, observer);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void EndOfMessageEncountered()</div><div class="line">    &#123;</div><div class="line">        var deserializer = new WireFormatDeserializer();</div><div class="line">        var message = deserializer.Deserialize(freeBytes.ToArray());</div><div class="line"></div><div class="line">        foreach (var observer in observers)</div><div class="line">            observer.OnNext(message);</div><div class="line">        freeBytes.Clear();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private class Unsubscriber: IDisposable</div><div class="line">    &#123;</div><div class="line">        private List&lt;IObserver&lt;string&gt;&gt; _observers;</div><div class="line">        private IObserver&lt;string&gt; _observer;</div><div class="line"></div><div class="line">        public Unsubscriber(List&lt;IObserver&lt;string&gt;&gt; observers, IObserver&lt;string&gt; observer)</div><div class="line">        &#123;</div><div class="line">            this._observers = observers;</div><div class="line">            this._observer = observer;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void Dispose()</div><div class="line">        &#123;</div><div class="line">            if (_observer != null &amp;&amp; _observers.Contains(_observer))</div><div class="line">                _observers.Remove(_observer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Most of this class is boilerplate code for wiring up observers. The crux is that we read bytes into a buffer until we encounter the stop bit which we discard and deserialize the buffer before clearing it ready for the next message. This seemed to work pretty well. There could be some additional work done around the message formats for the wire for instance adding more complete checksums and a retry policy. I'd like to get some experimental data on how well the current set up works in the real world before going to that length.</p>
<p>On the Android side I wrapped this observable with a thing to actually read the file so it ended up looking like</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerialReader</span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> _device &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line"></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> Starts a serial reader on the given device</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="device"&gt;</span>The device to start a reader on. Defaults to /dev/ttyS3<span class="doctag">&lt;/param&gt;</span></span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SerialReader</span>(<span class="params"><span class="keyword">string</span> device = <span class="string">"/dev/ttyS3"</span></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!device.StartsWith(<span class="string">"/dev/"</span>))</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Device must be /dev/tty&lt;something&gt;"</span>);</div><div class="line">        _device = device;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> BufferedMessageReader reader = <span class="keyword">new</span> BufferedMessageReader();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IObservable&lt;<span class="keyword">string</span>&gt; <span class="title">GetMessageObservable</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> reader;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ProcessBytes</span>(<span class="params"><span class="keyword">byte</span>[] bytes</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> i = bytes.Length - <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (i &gt;= <span class="number">0</span> &amp;&amp; bytes[i] == <span class="number">0</span>)</div><div class="line">            --i;</div><div class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">var</span> trimmedBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[i + <span class="number">1</span>];</div><div class="line">        Array.Copy(bytes, trimmedBytes, i + <span class="number">1</span>);</div><div class="line">        reader.AddBytes(trimmedBytes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> readThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(StartThread));</div><div class="line">        readThread.Start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StartThread</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> readHandle = File.Open(_device, FileMode.Open, FileAccess.Read, FileShare.ReadWrite);</div><div class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> readBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2000</span>];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (readHandle.CanRead)</div><div class="line">                readHandle.Read(readBuffer, <span class="number">0</span>, <span class="number">2000</span>);</div><div class="line">            ProcessBytes(readBuffer);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now listening for messages is as easy as doing</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">BaudSetter.SetupUpSerialSocket(); <span class="comment">//sets up the baud rate</span></div><div class="line"><span class="keyword">var</span> reader = <span class="keyword">new</span> SerialReader(); <span class="comment">//create a new serial reader</span></div><div class="line">reader.GetMessageObservable().Subscribe((message) =&gt; Log(message));<span class="comment">//subscribe to new messages</span></div><div class="line">reader.Start();<span class="comment">//start the listener</span></div></pre></td></tr></table></figure>
<p>One way communication squared away. Now to get messages back from the tablet to the computer. First stop was writing to the file on Android. Again we can make use of the fact that the serial port is just a file</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerialWriter</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> _device &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SerialWriter</span>(<span class="params"><span class="keyword">string</span> device = <span class="string">"/dev/ttyS3"</span></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!device.StartsWith(<span class="string">"/dev/"</span>))</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"Device must be /dev/tty&lt;something&gt;"</span>);</div><div class="line">        _device = device;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params"><span class="keyword">string</span> toWrite</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> writeHandle = File.Open(_device, FileMode.Open, FileAccess.ReadWrite, FileShare.ReadWrite);</div><div class="line"></div><div class="line">        <span class="keyword">var</span> bytes = <span class="keyword">new</span> WireFormatSerializer().Serialize(toWrite);</div><div class="line">        <span class="keyword">if</span> (writeHandle.CanWrite)</div><div class="line">        &#123;</div><div class="line">            writeHandle.Write(bytes, <span class="number">0</span>, bytes.Length);</div><div class="line">        &#125;</div><div class="line">        writeHandle.Close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Really no more than just writing to a file like normal. Closing the file descriptor after each write seemed to make things work better. On the Windows side the serial port already has a data received event built into it so we can just go and add an event handler.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">serialPort.DataReceived += DataReceivedHandler;</div></pre></td></tr></table></figure>
<p>This can then be hooked up like so</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> BufferedMessageReader reader = <span class="keyword">new</span> BufferedMessageReader();</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DataReceivedHandler</span>(<span class="params"></span></span></div><div class="line">                <span class="keyword">object</span> sender,</div><div class="line">                SerialDataReceivedEventArgs e)</div><div class="line">&#123;</div><div class="line">    SerialPort sp = (SerialPort)sender;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> bytesToRead = sp.BytesToRead;<span class="comment">//need to create a variable for this because it can change between lines</span></div><div class="line">    <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[bytesToRead];</div><div class="line">    sp.Read(bytes, <span class="number">0</span>, bytesToRead);</div><div class="line"></div><div class="line">    reader.AddBytes(bytes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And that is pretty much that. This code all put together allows sending and receiving messages on a serial port. You can check out the full example at https://github.com/ClearMeasure/AndroidSerialPort where we'll probably add any improvements we find necessary as we make use of the code.</p>
<p>*There is probably some way to grant your user account the ability to do this but I didn't look into it</p>

	        </div>

            
            <section id="comments">
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </div>
            </section>
            
		</div>
	</div>
<!--MAIN CONTENT ENDS-->

<!--SIDEBAR CONTENT STARTS-->
	<div class="SubpageBoxSubSm">
		<div class="SubpageBoxSubSmContent">
			
			

			<div class="ProfileImg">
				
				<a href="/bios/simon_timms">
				
					<img src='/images/avatars/simon.jpg' />
				
				</a>
				
			</div>

			<BR clear="all">

			<h2><a href="/bios/simon_timms">Simon Timms</a></h2>
			
			<a href="mailto:stimms@gmail.com"><img class="ProfileIcon" src="/images/icon_email.png" border="0" alt="Email" title="Email"> Email</a><BR>
			
			
			<a href="http://blog.simontimms.com/" target="_blank"><img class="ProfileIcon" src="/images/icon_web.png" border="0" alt="Web" title="Web"> Web</a><BR>
			
			
			<a href="http://twitter.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_twitter.png" border="0" alt="Twitter" title="Twitter"> Twitter</a><BR>
			
			
			<a href="https://github.com/stimms" target="_blank"><img class="ProfileIcon" src="/images/icon_github.png" border="0" alt="GitHub" title="GitHub"> GitHub</a><br>
			
			
			
 			<a href="/feeds/simon_timms"><img class="ProfileIcon" src="/images/icon_subscribe.png" /> RSS</a>
			

			<hr />
			<h4>Looking for someone else?</h4>
			<p>You can find the rest of the Western Devs Crew <a href="/whoweare">here</a>.</p>
		</div>
	</div>
<!--SIDEBAR CONTENT ENDS-->


</div>
</center>
<!--PAGE CONTENT ENDS-->


<!--FOOTER STARTS-->
<center>
  <div class="FooterBarTxt">&copy; 2015 Western Devs. All Rights Reserved. Design by <a href="http://www.karenchudobiak.ca" target="_blank">Karen Chudobiak, Graphic Designer</a></div>
</center>
<!--FOOTER ENDS-->

<!-- NAV FOOTER STARTS -->
<div class="NavFooter">
  <a href="/posts" alt="Posts"><i class="fa fa-newspaper-o fa-2x"></i><span>Posts</span></a>
  <a href="/podcasts" alt="Podcasts"><i class="fa fa-volume-up fa-2x"></i><span>Podcasts</span></a>
  <a href="/whoweare" alt="About"><i class="fa fa-star fa-2x"></i><span>About</span></a>
  <a href="/whatwevedone" alt="What We've Done"><i class="fa fa-trophy fa-2x"></i><span>Work</span></a>
  <a href="/speaking" alt="Speaking"><i class="fa fa-comment-o fa-2x fa-flip-horizontal"></i><span>Speaking</span></a>
</div>
<!-- NAV FOOTER ENDS -->




</div>
<!--WRAPPER ENDS-->


<script>
  var disqus_shortname = 'westerndevs';
  
  var disqus_url = 'http://www.westerndevs.com/development/AndroidSerialPorts/'.replace(".com//", ".com/");
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

</script>


</body>

  
<!-- Google Analytics -->
<script type="text/javascript">
if (document.location.hostname.search("westerndevs.com") !== -1 || document.location.hostname.search("www.westerndevs.com") !== -1) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37617956-2', 'auto');

ga('set', 'contentGroup1', 'simon_timms');

ga('send', 'pageview');
}
</script>
<!-- End Google Analytics -->



</html>
